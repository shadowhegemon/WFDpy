{% extends "base.html" %}

{% block title %}Edit Contact{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h2><i class="bi bi-pencil"></i> Edit Contact: {{ contact.callsign }}</h2>
                        <small class="text-muted">Logged: {{ contact.datetime.strftime('%m/%d/%Y %H:%M') }}</small>
                    </div>
                    <div class="card-body">
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}

                        <form method="POST">
                            {{ form.hidden_tag() }}
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.callsign.label(class="form-label") }}
                                    {{ form.callsign(class="form-control form-control-lg", placeholder="W1AW") }}
                                    {% if form.callsign.errors %}
                                        <div class="text-danger">{{ form.callsign.errors[0] }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.frequency.label(class="form-label") }}
                                    {{ form.frequency(class="form-control", placeholder="14.205") }}
                                    {% if form.frequency.errors %}
                                        <div class="text-danger">{{ form.frequency.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.mode.label(class="form-label") }}
                                    {{ form.mode(class="form-select") }}
                                    {% if form.mode.errors %}
                                        <div class="text-danger">{{ form.mode.errors[0] }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-3 mb-3">
                                    {{ form.rst_sent.label(class="form-label") }}
                                    {{ form.rst_sent(class="form-control") }}
                                    {% if form.rst_sent.errors %}
                                        <div class="text-danger">{{ form.rst_sent.errors[0] }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-3 mb-3">
                                    {{ form.rst_received.label(class="form-label") }}
                                    {{ form.rst_received(class="form-control") }}
                                    {% if form.rst_received.errors %}
                                        <div class="text-danger">{{ form.rst_received.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.exchange_sent.label(class="form-label") }}
                                    <div class="input-group">
                                        {{ form.exchange_sent(class="form-control", placeholder="2M EPA") }}
                                        {% if station_info %}
                                            <button type="button" class="btn btn-outline-secondary" onclick="updateExchangeSent()">
                                                <i class="bi bi-arrow-clockwise"></i> Use Station Setup
                                            </button>
                                        {% endif %}
                                    </div>
                                    <small class="form-text text-muted">
                                        {% if station_info %}
                                            Current station setup: <strong>{{ station_info.wfd_category }} {{ station_info.arrl_section }}</strong>
                                        {% else %}
                                            Format: [Number][Class] + Section (e.g., "2M EPA", "1H GA", "3O WTX")
                                        {% endif %}
                                    </small>
                                    {% if form.exchange_sent.errors %}
                                        <div class="text-danger">
                                            <i class="bi bi-exclamation-triangle"></i> {{ form.exchange_sent.errors[0] }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.exchange_received.label(class="form-label") }}
                                    {{ form.exchange_received(class="form-control", placeholder="1H CA") }}
                                    <small class="form-text text-muted">Format: [Number][Class] + Section - ARRL section will be auto-extracted</small>
                                    {% if form.exchange_received.errors %}
                                        <div class="text-danger">
                                            <i class="bi bi-exclamation-triangle"></i> {{ form.exchange_received.errors[0] }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>


                            <div class="mb-3">
                                {{ form.notes.label(class="form-label") }}
                                {{ form.notes(class="form-control", rows="3", placeholder="Optional notes...") }}
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                <div>
                                    <a href="{{ url_for('contacts') }}" class="btn btn-secondary me-2">
                                        <i class="bi bi-arrow-left"></i> Back to Contacts
                                    </a>
                                    <button type="button" class="btn btn-outline-danger" onclick="confirmDelete({{ contact.id }}, '{{ contact.callsign }}')">
                                        <i class="bi bi-trash"></i> Delete Contact
                                    </button>
                                </div>
                                <div>
                                    {{ form.submit(class="btn btn-success btn-lg") }}
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-info-circle"></i> Winter Field Day Exchange Format</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <strong>Required Format:</strong> [Number][Class] + ARRL Section (exactly 2 parts separated by space)
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Valid Classes:</h6>
                                    <ul class="list-unstyled">
                                        <li><span class="badge bg-warning me-2">H</span> Home station</li>
                                        <li><span class="badge bg-primary me-2">I</span> Indoor station</li>
                                        <li><span class="badge bg-success me-2">O</span> Outdoor station</li>
                                        <li><span class="badge bg-secondary me-2">M</span> Mobile station</li>
                                    </ul>
                                    <small class="text-muted">Number = simultaneous transmitters (1-9+)</small>
                                </div>
                                <div class="col-md-6">
                                    <h6>Valid Examples:</h6>
                                    <ul class="list-unstyled">
                                        <li><code class="text-success">2M EPA</code> ✓ Correct</li>
                                        <li><code class="text-success">1H GA</code> ✓ Correct</li>
                                        <li><code class="text-success">3O WTX</code> ✓ Correct</li>
                                        <li><code class="text-danger">2M</code> ✗ Missing section</li>
                                        <li><code class="text-danger">EPA</code> ✗ Missing category</li>
                                        <li><code class="text-danger">2B EPA</code> ✗ Invalid class letter</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="mt-3 p-2 bg-light rounded">
                                <small><strong>Note:</strong> ARRL sections will be automatically extracted and validated. 
                                Must be valid sections like WI, CA, NY, TX, etc.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-uppercase callsign
    document.getElementById('callsign').addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase();
    });

    function confirmDelete(contactId, callsign) {
        if (confirm(`Are you sure you want to delete the contact with ${callsign}? This action cannot be undone.`)) {
            // Create a form to submit the delete request
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/delete/${contactId}`;
            
            document.body.appendChild(form);
            form.submit();
        }
    }

    {% if station_info %}
    function updateExchangeSent() {
        document.getElementById('exchange_sent').value = '{{ station_info.wfd_category }} {{ station_info.arrl_section }}';
    }
    {% endif %}
</script>
{% endblock %}